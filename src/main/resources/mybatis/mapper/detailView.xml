<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="poris.fruitlight.dao.DetailViewDao">
	
	<!-- 2023.08.13 고재승 -->
	<!-- 게시글 번호를 기준으로 상품 정보를 조회하는 SQL문 -->
	<select id="selectByBno" parameterType="int" resultType="ProductBoard">
      select BOARD_NO as boardNo,
      p.PRODUCT_NO as productNo,
      PRODUCT_NAME as productName,
      PRODUCT_PRICE as productPrice,
      PRODUCT_OPTION as productOption,
      DISCOUNT_RATE as DiscountRate,
      DISCOUNT_PRICE as DiscountPrice
	  from PRODUCT p, PRODUCT_BOARD b
	  where p.PRODUCT_NO = b.PRODUCT_NO
	  and BOARD_NO = #{bno}
   </select>
   
	<select id="selectByBnoTest" parameterType="int" resultType="poris.fruitlight.dto.Product">
      select b.BOARD_NO, p.PRODUCT_NO, PRODUCT_NAME, PRODUCT_PRICE, PRODUCT_OPTION, DISCOUNT_RATE, DISCOUNT_PRICE, MEDIA_NAME, MEDIA_DATA
	  from PRODUCT p, PRODUCT_BOARD b, BOARD_MEDIA m
	  where p.PRODUCT_NO = b.PRODUCT_NO
      and b.BOARD_NO = m.BOARD_NO
	  and b.BOARD_NO = 1
      and (MEDIA_NAME like '%sm%' or MEDIA_NAME like '%main%')
   </select>
   
   <select id="selectByName" parameterType="String" resultType="poris.fruitlight.dto.Product">
      select PRODUCT_NO, DISCOUNT_PRICE, PRODUCT_OPTION
      from PRODUCT
      where PRODUCT_NAME = #{name}
   </select>
    
   <update id="updateCartStock" parameterType="poris.fruitlight.dto.Cart">
      MERGE INTO CART
	  USING DUAL
	     ON (SHOPPER_NO = #{SHOPPER_NO} and PRODUCT_NO = #{PRODUCT_NO})
	  WHEN MATCHED THEN
	      UPDATE SET CART_PRODUCT_STOCK = #{CART_PRODUCT_STOCK} + CART_PRODUCT_STOCK
	  WHEN NOT MATCHED THEN
	      INSERT (SHOPPER_NO, PRODUCT_NO, CART_PRODUCT_STOCK) 
	      VALUES (#{SHOPPER_NO}, #{PRODUCT_NO}, #{CART_PRODUCT_STOCK})
   </update>
   <!-- <update id="updateCartStock" parameterType="java.util.List">
   	  <foreach collection="list" index="index" item="cart" open="DECLARE BEGIN" separator="; " close="; END;">
	      MERGE INTO CART
		  USING DUAL
		     ON (SHOPPER_NO = #{cart.SHOPPER_NO} and PRODUCT_NO = #{cart.PRODUCT_NO})
		  WHEN MATCHED THEN
		      UPDATE SET CART_PRODUCT_STOCK = #{cart.CART_PRODUCT_STOCK} + CART_PRODUCT_STOCK
		  WHEN NOT MATCHED THEN
		      INSERT (SHOPPER_NO, PRODUCT_NO, CART_PRODUCT_STOCK)
		      VALUES (#{cart.SHOPPER_NO}, #{cart.PRODUCT_NO}, #{cart.CART_PRODUCT_STOCK})
	  </foreach>
   </update> -->
   
   <select id="selectProductInquiryPager" parameterType="poris.fruitlight.dto.Pager" resultType="poris.fruitlight.dto.ProductInquiry">
      <![CDATA[
         select rnum, INQUIRY_NO, INQUIRY_CONTENT, INQUIRY_DATE, EMPTANSWER, ANSWER_CONTENT, ANSWER_DATE
         from (
            select rownum as rnum, INQUIRY_NO, INQUIRY_CONTENT, INQUIRY_DATE, EMPTANSWER, ANSWER_CONTENT, ANSWER_DATE
            from (
               select INQUIRY_NO, INQUIRY_CONTENT, INQUIRY_DATE, EMPTANSWER, ANSWER_CONTENT, ANSWER_DATE
               from PRODUCT_INQUIRY
               where BOARD_NO = #{BOARD_NO}
               order by INQUIRY_NO desc
            )
            where rownum <= #{endRowNo}
         )
         where rnum >= #{startRowNo}
      ]]>
   </select>
   
   <select id="count" parameterType="int" resultType="int">
      select count(*) from PRODUCT_INQUIRY
      where BOARD_NO = #{BOARD_NO}
   </select>
  
</mapper>
