<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="poris.fruitlight.dao.OrderHistoryDao">
   <select id="SelectOrderHistory" resultType="poris.fruitlight.dto.OrderHistoryOrderList">
       SELECT oh.ORDER_NO as ORDER_NO,
             oh.SHOPPER_NO as SHOPPER_NO,
             PRODUCT_NAME,
             SHIPPING_NAME,
             SHIPPING_ADDRESS,
             ORDER_DATE,
             MEDIA_DATA,
             p.DISCOUNT_PRICE as DISCOUNT_PRICE,
             STOCK 
          FROM ORDER_HISTORY oh
          JOIN RECEIPT_HISTORY rh ON oh.ORDER_NO = rh.ORDER_NO
          JOIN SHIPPING_ADDRESS sa ON oh.ADDRESS_NO = sa.ADDRESS_NO
          JOIN SHOPPER s ON oh.SHOPPER_NO = s.SHOPPER_NO
          JOIN PRODUCT p ON rh.PRODUCT_NO = p.PRODUCT_NO
          JOIN PRODUCT_BOARD pb ON p.PRODUCT_NO = pb.PRODUCT_NO
          JOIN BOARD_MEDIA bm ON pb.BOARD_NO = bm.BOARD_NO
          WHERE oh.SHOPPER_NO = #{sid} AND bm.MEDIA_NAME LIKE '%list_thumbnail%'
          ORDER BY ORDER_DATE DESC
   </select>
   
   <select id="SearchOrdersByPname" parameterType="OrderSearch" resultType="poris.fruitlight.dto.OrderHistoryOrderList">
        SELECT oh.ORDER_NO as ORDER_NO,
             oh.SHOPPER_NO as SHOPPER_NO,
             PRODUCT_NAME,
             SHIPPING_NAME,
             SHIPPING_ADDRESS,
             ORDER_DATE,
             MEDIA_DATA,
             p.DISCOUNT_PRICE as DISCOUNT_PRICE,
             STOCK
        FROM ORDER_HISTORY oh
        JOIN RECEIPT_HISTORY rh ON oh.ORDER_NO = rh.ORDER_NO
        JOIN SHIPPING_ADDRESS sa ON oh.ADDRESS_NO = sa.ADDRESS_NO
        JOIN SHOPPER s ON oh.SHOPPER_NO = s.SHOPPER_NO
        JOIN PRODUCT p ON rh.PRODUCT_NO = p.PRODUCT_NO
        JOIN PRODUCT_BOARD pb ON p.PRODUCT_NO = pb.PRODUCT_NO
        JOIN BOARD_MEDIA bm ON pb.BOARD_NO = bm.BOARD_NO
        WHERE oh.SHOPPER_NO = #{shopperNo} AND p.PRODUCT_NAME LIKE '%' || #{searchKeyword} || '%' AND MEDIA_NAME LIKE '%list_thumbnail%'
        ORDER BY ORDER_DATE DESC
    </select>
    
    <!-- 작정자: 이은지 -->
	<insert id="insertOrderHistory" parameterType="poris.fruitlight.dto.OrderHistory">
		<selectKey keyProperty="ORDER_NO" resultType="int" order="BEFORE">
			select ORDER_NO_SEQ.nextval from dual
		</selectKey>
		insert into ORDER_HISTORY (
			ORDER_NO, SHOPPER_NO, ADDRESS_NO, ORDER_DATE, TOTAL_PRICE, DISCOUNT_PRICE, SHIPPING_PRICE, 
			PAYMENT_PRICE, PAYMENT_TYPE, CASH_RECEIPT_PURPOSE, CASH_RECEIPT_TYPE, CASH_RECEIPT_NO
		)
		values(
			#{ORDER_NO}, #{SHOPPER_NO}, #{ADDRESS_NO}, #{ORDER_DATE}, #{TOTAL_PRICE}, #{DISCOUNT_PRICE}, #{SHIPPING_PRICE}, 
			#{PAYMENT_PRICE}, #{PAYMENT_TYPE}, #{CASH_RECEIPT_PURPOSE}, #{CASH_RECEIPT_TYPE}, #{CASH_RECEIPT_NO}
		)
	</insert>
	
	<!-- 작성자: 이은지 -->
	<insert id="insertReceiptHistory" parameterType="poris.fruitlight.dto.ReceiptHistory">
		<selectKey keyProperty="ORDER_NO" resultType="int" order="BEFORE">
			select ORDER_NO_SEQ.currval from dual
		</selectKey>
		insert into RECEIPT_HISTORY (ORDER_NO, PRODUCT_NO, PRICE, STOCK)
		values(#{ORDER_NO}, #{PRODUCT_NO}, #{PRICE}, #{STOCK})
	</insert>
</mapper>